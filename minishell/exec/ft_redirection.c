//  ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£§‚£¶‚£¥‚£∂‚£æ‚£ø‚£∂‚£∂‚£∂‚£∂‚£¶‚£§‚£Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä                                              
//  ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚°∂‚†ª‚†õ‚†ü‚†ã‚†â‚†Ä‚†à‚†§‚†¥‚†∂‚†∂‚¢æ‚£ø‚£ø‚£ø‚£∑‚£¶‚†Ñ‚†Ä‚†Ä‚†Ä        ìêì  ft_redirection.c ìêî           
//  ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†î‚†ã‚†Ä‚†Ä‚†§‚†í‚†í‚¢≤‚†Ä‚†Ä‚†Ä‚¢Ä‚£†‚£§‚£§‚£¨‚£Ω‚£ø‚£ø‚£ø‚£∑‚£Ñ‚†Ä‚†Ä                                              
//  ‚†Ä‚†Ä‚†Ä‚£Ä‚£é‚¢§‚£∂‚£æ‚†Ö‚†Ä‚†Ä‚¢Ä‚°§‚†è‚†Ä‚†Ä‚†Ä‚††‚£Ñ‚£à‚°ô‚†ª‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£¶‚†Ä Student: mait-taj <mait-taj@student.1337.ma> 
//  ‚¢Ä‚†î‚†â‚†Ä‚†ä‚†ø‚†ø‚£ø‚†Ç‚††‚†¢‚£§‚†§‚£§‚£º‚£ø‚£∂‚£∂‚£§‚£ù‚£ª‚£∑‚£¶‚£ç‚°ª‚£ø‚£ø‚£ø‚£ø‚°Ä                                              
//  ‚¢æ‚£æ‚£Ü‚£§‚£§‚£Ñ‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†â‚¢ª‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á                                              
//  ‚†Ä‚†à‚¢ã‚¢π‚†ã‚†â‚†ô‚¢¶‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚£º‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°á      Created: 2025/03/28 21:50:56 by mait-taj
//  ‚†Ä‚†Ä‚†Ä‚†ë‚†Ä‚†Ä‚†Ä‚†à‚°á‚†Ä‚†Ä‚†Ä‚†Ä‚£†‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†á      Updated: 2025/03/28 21:51:05 by mait-taj
//  ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°á‚†Ä‚†Ä‚¢Ä‚£æ‚£ø‚£ø‚†ø‚†ü‚†õ‚†ã‚†õ‚¢ø‚£ø‚£ø‚†ª‚£ø‚£ø‚£ø‚£ø‚°ø‚†Ä                                              
//  ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚†á‚†Ä‚¢†‚£ø‚£ü‚£≠‚£§‚£∂‚£¶‚£Ñ‚°Ä‚†Ä‚†Ä‚†à‚†ª‚†Ä‚†ò‚£ø‚£ø‚£ø‚†á‚†Ä                                              
//  ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†±‚†§‚†ä‚†Ä‚¢Ä‚£ø‚°ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£ø‚†è‚†Ä‚†Ä                             ìÜ©‚ôïìÜ™      
//  ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚°Ñ‚†Ä‚†Ä‚†Ä‚†ò‚¢ß‚°Ä‚†Ä‚†Ä‚†∏‚£ø‚£ø‚£ø‚†ü‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ê‚†ã‚†Ä‚†Ä‚†Ä                           ìÑÇ mait-tajìÜÉ  
//  ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚†Ñ‚£Ä‚°Ä‚†∏‚†ì‚†Ä‚†Ä‚†Ä‚††‚†ü‚†ã‚†Å‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä                                              

#include "../minishell.h"

void	redir_in(t_command *cmd)
{
	t_redir	*redir;
	t_redir	*save;

	redir = cmd->redirect;
	while (redir)
	{
		if (redir->type == REDIR_IN)
			save = redir;
		redir = redir->next;
	}
	if (save)
	{
		save->fd = open(save->file, O_RDONLY, 0644);
		if (save->fd < 0)
			perror("open");
		if (cmd->last_input == REDIR_IN && check_if_builtins(cmd) == false)
			dup2(save->fd, STDIN_FILENO);
		close(save->fd);
	}
}

void	d_redir_out(t_command *cmd)
{
	t_redir	*redir;
	t_redir	*save;

	redir = cmd->redirect;
	while (redir)
	{
		if (redir->type == APEND)
			save = redir;
		redir = redir->next;
	}
	if (save)
	{
		save->fd = open(save->file, O_WRONLY | O_APPEND, 0644);
		if (save->fd < 0)
			perror("open");
		dup2(save->fd, STDOUT_FILENO);
		close(save->fd);
	}
}

void	redir_out(t_command *cmd)
{
	t_redir	*redir;
	t_redir	*save;

	redir = cmd->redirect;
	while (redir)
	{
		if (redir->type == REDIR_OUT)
			save = redir;
		redir = redir->next;
	}
	if (save)
	{
		save->fd = open(save->file, O_RDWR | O_TRUNC, 0644);
		if (save->fd < 0)
		{
			perror("open");
		}
		dup2(save->fd, STDOUT_FILENO);
		close(save->fd);
	}
}

void	redirect_to(t_command *cmd)
{
	t_redir		*redir;
	bool		in;
	bool		out;
	bool		app;

	redir = cmd->redirect;
	while (redir)
	{
		if (redir->type == REDIR_IN && in != true)
		{
			in = true;
			redir_in(cmd);
		}
		else if (redir->type == REDIR_OUT && out != true)
		{
			out = true;
			redir_out(cmd);
		}
		else if (redir->type == APEND && app != true)
		{
			app = true;
			d_redir_out(cmd);
		}
		redir = redir->next;
	}
}

int	ft_redirection(t_command *cmd)
{
	t_redir	*redir;

	redir = cmd->redirect;
	while (redir)
	{
		if (redir->type == REDIR_OUT)
			redir->fd = open(redir->file, O_CREAT | O_TRUNC | O_RDWR, 0644);
		else if (redir->type == REDIR_IN)
			redir->fd = open(redir->file, O_RDONLY, 0644);
		else if (redir->type == APEND)
			redir->fd = open(redir->file, O_CREAT | O_APPEND | O_RDWR, 0644);
		if (redir->fd < 0)
			return (redir->fd);
		close(redir->fd);
		redir = redir->next;
	}
	return (1);
}
